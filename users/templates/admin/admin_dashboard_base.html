{% load static %}
<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block admin_title %}Admin Dashboard - EventPro{% endblock %}</title>
    <link rel="stylesheet" href="{% static 'output.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for webkit browsers */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; /* Tailwind gray-300 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; /* Tailwind gray-400 */
        }
        .sidebar-link {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: 0.375rem; /* rounded-md */
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
        }
        .sidebar-link:hover, .sidebar-link.active {
            background-color: #059669; /* emerald-600 */
            color: white;
        }
        .sidebar-link i {
            margin-right: 0.75rem;
            width: 1.25rem; /* w-5 */
            text-align: center;
        }
        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: white;
            padding: 1.5rem; /* p-6 */
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); /* shadow-xl */
            width: 90%;
            max-width: 500px; /* md:max-w-lg */
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .modal-overlay.active .modal-content {
            transform: scale(1);
        }
        .loading-spinner {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #059669; /* Emerald 600 */
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    {% block extra_admin_css %}{% endblock %}
</head>
<body class="bg-gray-100 text-gray-800 h-full">
    <div class="flex h-full overflow-hidden">
        <aside class="w-72 bg-emerald-800 text-emerald-100 flex flex-col fixed inset-y-0 left-0 z-30 shadow-lg transform md:translate-x-0 -translate-x-full transition-transform duration-300 ease-in-out" id="adminSidebar">
            <div class="p-4 border-b border-emerald-700">
                <a href="{% url 'admin_dashboard' %}" class="flex items-center space-x-2">
                    <i class="fas fa-cogs text-2xl text-amber-300"></i>
                    <span class="text-2xl font-bold text-white">EventPro Admin</span>
                </a>
            </div>
            <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
                <a href="{% url 'admin_dashboard' %}" class="sidebar-link {% if request.resolver_match.url_name == 'admin_dashboard' %}active{% endif %}">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </a>
                
                <div>
                    <button class="sidebar-link w-full text-left text-sm focus:outline-none {% if 'admin_users' in request.path or 'admin_groups' in request.path or 'admin_permissions' in request.path %}bg-emerald-700{% endif %}" 
                            onclick="toggleDropdown('userManagementDropdown')">
                        <i class="fas fa-users"></i>
                        <span class="text-white">User Management</span>
                        <i class="fas fa-chevron-down ml-auto transform transition-transform duration-200 {% if 'admin_users' in request.path or 'admin_groups' in request.path or 'admin_permissions' in request.path %}rotate-180{% endif %}" 
                           id="userManagementDropdownIcon"></i>
                    </button>
                    <div id="userManagementDropdown" class="pl-8 space-y-1 mt-1 text-xs {% if 'admin_users' in request.path or 'admin_groups' in request.path or 'admin_permissions' in request.path %}block{% else %}hidden{% endif %}">
                        <div class="flex justify-between items-center">
                            <a href="{% url 'admin_users' %}" 
                               class="block py-1 px-2 hover:bg-emerald-700 rounded-md {% if request.path == '/admin/users/' %}bg-emerald-700 text-white font-medium{% endif %}">
                                Users
                            </a>
                            <a href="{% url 'admin:core_user_add' %}" 
                               class="block py-1 px-2 hover:bg-emerald-700 rounded-md">
                                <i class="fa fa-plus" aria-hidden="true"></i> Add
                            </a>
                        </div>
                        <div class="flex justify-between items-center">
                            <a href="{% url 'admin_groups' %}" 
                               class="block text-xs py-1 px-2 hover:bg-emerald-700 rounded-md {% if request.path == '/admin/groups/' %}bg-emerald-700 text-white font-medium{% endif %}">
                                Groups
                            </a>
                            <a href="{% url 'admin:auth_group_add' %}" 
                               class="block text-xs py-1 px-2 hover:bg-emerald-700 rounded-md">
                                <i class="fa fa-plus" aria-hidden="true"></i> Add
                            </a>
                        </div>
                        <div class="flex justify-between items-center">
                            <a href="{% url 'admin_permissions' %}" 
                               class="block text-xs py-1 px-2 hover:bg-emerald-700 rounded-md {% if request.path == '/admin/permissions/' %}bg-emerald-700 text-white font-medium{% endif %}">
                                Permissions
                            </a>
                            <a href="{% url 'admin:auth_permission_add' %}" 
                               class="block text-xs py-1 px-2 hover:bg-emerald-700 rounded-md">
                                <i class="fa fa-plus" aria-hidden="true"></i> Add
                            </a>
                        </div>
                    </div>
                </div>

                <div>
                    <button class="sidebar-link w-full text-left text-xs focus:outline-none" onclick="toggleDropdown('eventManagementDropdown')">
                        <i class="fas fa-calendar-alt"></i>
                        <span class="text-white">Event Management</span>
                        <i class="fas fa-chevron-down ml-auto transform transition-transform duration-200" id="eventManagementDropdownIcon"></i>
                    </button>
                    <div id="eventManagementDropdown" class="hidden pl-8 space-y-1 mt-1">
                        <div class="flex justify-between">
                            <div>
                                <a href="{% url 'admin_events' %}" class="block text-xs py-1 px-2 hover:bg-emerald-700 rounded-md">Events</a>
                            </div>
                            <div>
                                <a href="{% url 'admin_users' %}" class="block text-xs py-1 px-2 hover:bg-emerald-700 rounded-md"><i class="fa fa-plus" aria-hidden="true"></i></i> Add</a>
                            </div>
                        </div>
                        <div class="flex justify-between">
                            <div>
                                <a href="{% url 'admin_categories' %}" class="block text-xs py-1 px-2 hover:bg-emerald-700 rounded-md">Event Categories</a>
                            </div>
                            <div>
                                <a href="{% url 'admin_users' %}" class="block text-xs py-1 px-2 hover:bg-emerald-700 rounded-md"><i class="fa fa-plus" aria-hidden="true"></i></i> Add</a>
                            </div>
                        </div>
                        <div class="flex justify-between">
                            <div>
                                <a href="{% url 'admin_registrations' %}" class="block text-xs py-1 px-2 hover:bg-emerald-700 rounded-md">Event registrationsnts</a>
                            </div>
                            <div>
                                <a href="{% url 'admin_users' %}" class="block text-xs py-1 px-2 hover:bg-emerald-700 rounded-md"><i class="fa fa-plus" aria-hidden="true"></i></i> Add</a>
                            </div>
                        </div>
                        <div class="flex justify-between">
                            <div>
                                <a href="{% url 'admin_notifications' %}" class="block text-xs py-1 px-2 hover:bg-emerald-700 rounded-md">Notifications</a>
                            </div>
                            <div>
                                <a href="{% url 'admin_users' %}" class="block text-xs py-1 px-2 hover:bg-emerald-700 rounded-md"><i class="fa fa-plus" aria-hidden="true"></i></i> Add</a>
                            </div>
                        </div>
                        <div class="flex justify-between">
                            <div>
                                <a href="{% url 'admin_users' %}" class="block text-xs py-1 px-2 hover:bg-emerald-700 rounded-md">Profiles</a>
                            </div>
                            <div>
                                <a href="{% url 'admin_users' %}" class="block text-xs py-1 px-2 hover:bg-emerald-700 rounded-md"><i class="fa fa-plus" aria-hidden="true"></i></i> Add</a>
                            </div>
                        </div>
                        
                        <!-- <button class="block text-xs py-1 px-2 hover:bg-emerald-700 rounded-md w-full text-left mt-1 text-emerald-200" 
                                 onclick="openGeminiModal('Generate Event Description', 'Enter keywords for the event (e.g., tech conference, summer, AI focus)', '✨ Generate Description', handleEventDescription)">
                            ✨ Auto-Gen Description
                        </button> -->
                    </div>
                </div>

                <div>
                    <button class="sidebar-link w-full text-left text-sm focus:outline-none" onclick="toggleDropdown('aiToolsDropdown')">
                        <i class="fas fa-magic"></i>
                        <span class="text-white">AI Tools</span>
                        <i class="fas fa-chevron-down ml-auto transform transition-transform duration-200" id="aiToolsDropdownIcon"></i>
                    </button>
                    <div id="aiToolsDropdown" class="hidden pl-8 space-y-1 mt-1">
                        <button class="block text-sm py-1 px-2 hover:bg-emerald-700 rounded-md w-full text-left text-emerald-200"
                                 onclick="openGeminiModal('Event Idea Generator', '{% comment %}What kind of event are you thinking about? (e.g., corporate team building, charity fundraiser, kids birthday party){% endcomment %}  <<!! Not Implemented yet !!>>', '✨ Generate Ideas', displayGeneratedEventIdeas)"> 
                            Event Idea Generator
                        </button>
                         </div>
                </div>
                
                <a href="#" class="sidebar-link text-sm">
                    <i class="fas fa-file-alt"></i>
                    <span class="text-white">Reports</span>
                </a>
                <a href="#" class="sidebar-link text-sm">
                    <i class="fas fa-cogs"></i>
                    <span class="text-white">Site Settings</span>
                </a>
                 <a href="{% url 'public_home' %}" class="sidebar-link text-sm">
                    <i class="fas fa-globe"></i>
                    <span class="text-white">View Public Site</span>
                </a>
            </nav>
            <div class="p-4 border-t border-emerald-700">
                <div class="flex items-center">
                    <img src="https://placehold.co/40x40/059669/FFFFFF?text=A" alt="Admin User" class="w-8 h-8 rounded-full mr-2">
                    <div>
                        <p class="text-sm font-medium text-white">Admin User</p>
                        <a href="#" class="text-xs text-emerald-300 hover:text-amber-300">Logout</a>
                    </div>
                </div>
            </div>
        </aside>

        <div class="flex-1 flex flex-col md:ml-64 transition-all duration-300 ease-in-out">
            <header class="bg-white shadow-md p-4 flex justify-between items-center sticky top-0 z-20">
                
                <div class="pl-9">
                    <button class="text-gray-600 hover:text-emerald-600 md:hidden" id="openSidebarButton">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                    <h1 class="text-xl font-semibold text-emerald-800 hidden md:block">  Welcome To Admin Dashboard</h1>
                </div>
                <div class="flex font-bold text-emerald-600">
                    <a href="{% url 'user_home' %}">
                        <div class="hover:bg-emerald-100 rounded-full">
                            <p class="px-4 py-1">Home</p>
                        </div>
                    </a>
                    <a href="{% url 'manager_dashboard' %}">
                        <div class="hover:bg-emerald-100 rounded-full">
                            <p class="px-4 py-1">Manage Dashboard</p>
                        </div>
                    </a>
                    
                </div>
                <div class="flex items-center space-x-4">
                    <button class="text-gray-500 hover:text-emerald-600">
                        <i class="fas fa-bell"></i>
                    </button>
                    <form method="GET" action="#" class="relative">
                        <input type="search" name="q" placeholder="Search..." class="px-3 py-1.5 border border-gray-300 rounded-md focus:ring-emerald-500 focus:border-emerald-500 text-sm">
                        <button type="submit" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-emerald-600">
                            <i class="fas fa-search"></i>
                        </button>
                    </form>
                </div>
            </header>

            <div class="flex-1 overflow-y-auto">
                <main class="p-6">
                    {% block admin_content %}
                    
                    {% endblock %}
                </main>

                <footer class="bg-white p-12 m-6 ml-12 border-t border-gray-200 py-4 ">
                    <div class="flex justify-between items-center">
                        <div class="text-sm text-gray-600">
                            &copy; {% now "Y" %} EventPro. All rights reserved.
                        </div>
                        <div class="flex space-x-4">
                            <a href="#" class="text-gray-600 hover:text-emerald-600 text-sm">Privacy Policy</a>
                            <a href="#" class="text-gray-600 hover:text-emerald-600 text-sm">Terms of Service</a>
                            <a href="#" class="text-gray-600 hover:text-emerald-600 text-sm">Contact Support</a>
                        </div>
                    </div>
                </footer>
            </div>
        </div>
    </div>

    <div id="geminiApiModal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 id="geminiModalTitle" class="text-xl font-semibold text-emerald-800">AI Assistant</h3>
                <button onclick="closeGeminiModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>
            <textarea id="geminiModalPrompt" rows="4" class="w-full p-2 border border-gray-300 rounded-md focus:ring-emerald-500 focus:border-emerald-500" placeholder="Enter your prompt..."></textarea>
            <div id="geminiModalLoading" class="hidden my-4">
                <div class="loading-spinner"></div>
                <p class="text-center text-sm text-gray-600 mt-2">Generating...</p>
            </div>
            <div id="geminiModalError" class="hidden my-3 p-3 bg-red-100 text-red-700 rounded-md text-sm"></div>
            <div id="geminiModalResult" class="mt-4 p-3 bg-emerald-50 border border-emerald-200 rounded-md max-h-60 overflow-y-auto text-sm text-gray-700">
                </div>
            <button id="geminiModalSubmitButton" class="mt-6 w-full bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-2 px-4 rounded-md transition-colors duration-200">
                Generate
            </button>
        </div>
    </div>

    <script>
        // Sidebar toggle for mobile
        const adminSidebar = document.getElementById('adminSidebar');
        const openSidebarButton = document.getElementById('openSidebarButton');
        
        if (openSidebarButton && adminSidebar) {
            openSidebarButton.addEventListener('click', () => {
                adminSidebar.classList.toggle('-translate-x-full');
            });
        }

        // Dropdown toggle for sidebar items
        function toggleDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            const icon = document.getElementById(dropdownId + 'Icon');
            
            if (dropdown.classList.contains('hidden')) {
                dropdown.classList.remove('hidden');
                dropdown.classList.add('block');
                icon.classList.add('rotate-180');
            } else {
                dropdown.classList.remove('block');
                dropdown.classList.add('hidden');
                icon.classList.remove('rotate-180');
            }
        }
        
        // Close sidebar when clicking outside on mobile (optional)
        document.addEventListener('click', function(event) {
            if (!adminSidebar || !openSidebarButton) return;
            const isClickInsideSidebar = adminSidebar.contains(event.target);
            const isClickOnOpenButton = openSidebarButton.contains(event.target);

            if (!isClickInsideSidebar && !isClickOnOpenButton && !adminSidebar.classList.contains('-translate-x-full') && window.innerWidth < 768) {
                 adminSidebar.classList.add('-translate-x-full');
            }
        });

        // Gemini API Modal Logic
        const geminiModal = document.getElementById('geminiApiModal');
        const geminiModalTitle = document.getElementById('geminiModalTitle');
        const geminiModalPrompt = document.getElementById('geminiModalPrompt');
        const geminiModalSubmitButton = document.getElementById('geminiModalSubmitButton');
        const geminiModalResult = document.getElementById('geminiModalResult');
        const geminiModalLoading = document.getElementById('geminiModalLoading');
        const geminiModalError = document.getElementById('geminiModalError');
        let currentGeminiCallback = null;

        function openGeminiModal(title, promptPlaceholder, buttonText, callback) {
            geminiModalTitle.textContent = title;
            geminiModalPrompt.placeholder = promptPlaceholder;
            geminiModalPrompt.value = ''; // Clear previous prompt
            geminiModalSubmitButton.textContent = buttonText;
            geminiModalResult.innerHTML = ''; // Clear previous results
            geminiModalError.classList.add('hidden');
            geminiModalError.textContent = '';
            currentGeminiCallback = callback;
            geminiModal.classList.add('active');
            geminiModalSubmitButton.onclick = handleGeminiSubmit; // Assign fresh click handler
        }

        function closeGeminiModal() {
            geminiModal.classList.remove('active');
        }

        async function handleGeminiSubmit() {
            const prompt = geminiModalPrompt.value.trim();
            if (!prompt) {
                geminiModalError.textContent = 'Please enter a prompt.';
                geminiModalError.classList.remove('hidden');
                return;
            }

            geminiModalLoading.classList.remove('hidden');
            geminiModalResult.innerHTML = '';
            geminiModalError.classList.add('hidden');
            geminiModalSubmitButton.disabled = true;

            try {
                const textResponse = await callGeminiApi(prompt);
                if (currentGeminiCallback) {
                    currentGeminiCallback(textResponse); // Pass response to specific handler
                } else {
                    geminiModalResult.textContent = textResponse; // Default display
                }
            } catch (error) {
                console.error("Gemini API call failed:", error);
                geminiModalError.textContent = 'Failed to get response from AI. ' + (error.message || 'Please try again.');
                geminiModalError.classList.remove('hidden');
                geminiModalResult.innerHTML = ''; // Clear any partial results
            } finally {
                geminiModalLoading.classList.add('hidden');
                geminiModalSubmitButton.disabled = false;
            }
        }
        
        async function callGeminiApi(prompt) {
            // IMPORTANT: Replace with your actual Gemini API key and endpoint if needed.
            // For this environment, the API key is often handled by the platform.
            const apiKey = ""; // Leave empty if handled by the platform
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }]
            };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorData = await response.json();
                console.error("API Error Response:", errorData);
                throw new Error(`API request failed with status ${response.status}: ${errorData?.error?.message || response.statusText}`);
            }

            const result = await response.json();

            if (result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {
                return result.candidates[0].content.parts[0].text;
            } else {
                console.error("Unexpected API response structure:", result);
                throw new Error('Received an unexpected response structure from the AI.');
            }
        }

        // --- Specific Gemini Feature Handlers ---
        // Example: Handler for displaying event ideas (to be used by admin_dashboard_home.html)
        function displayGeneratedEventIdeas(ideasText) {
            geminiModalResult.innerHTML = `<p class="font-semibold mb-2">Generated Event Ideas:</p><div class="whitespace-pre-wrap">${ideasText.replace(/\n/g, '<br>')}</div>`;
            
           
        }

        // Function to check if a URL contains a specific path
        function isActivePath(path) {
            return window.location.pathname.includes(path);
        }

        // Initialize dropdowns based on current URL
        document.addEventListener('DOMContentLoaded', function() {
            const currentPath = window.location.pathname;
            const userManagementPaths = ['/admin/users/', '/admin/groups/', '/admin/permissions/'];
            
            if (userManagementPaths.some(path => currentPath.includes(path))) {
                const dropdown = document.getElementById('userManagementDropdown');
                const icon = document.getElementById('userManagementDropdownIcon');
                
                if (dropdown && icon) {
                    dropdown.classList.remove('hidden');
                    dropdown.classList.add('block');
                    icon.classList.add('rotate-180');
                }
            }
        });

    </script>
    {% block extra_admin_js %}{% endblock %}
</body>
</html>
